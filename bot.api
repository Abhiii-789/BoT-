const fs = require('fs');
const readline = require('readline');
const login = require('ws3-fca'); // ‡§®‡§à API

// ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§∏‡•á ‡§á‡§®‡§™‡•Å‡§ü ‡§≤‡•á‡§®‡•á ‡§ï‡§æ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®
const getInput = (query) => {
    const rl = readline.createInterface({
        input: process.stdin,
        output: process.stdout,
    });

    return new Promise((resolve) => rl.question(query, (answer) => {
        rl.close();
        resolve(answer);
    }));
};

// ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®
(async () => {
    console.log("\nüöÄ Termux Messenger Bot: Group Name & Nickname Lock Script\n");

    // ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§∏‡•á ‡§á‡§®‡§™‡•Å‡§ü ‡§≤‡•á‡§Ç
    const appstatePath = await getInput('üîë ‡§Ö‡§™‡§®‡§æ appstate.json ‡§´‡§º‡§æ‡§á‡§≤ ‡§ï‡§æ ‡§™‡§• ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç: ');
    const prefix = await getInput('‚úè ‡§ï‡§Æ‡§æ‡§Ç‡§° ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•ç‡§∞‡§ø‡§´‡§ø‡§ï‡•ç‡§∏ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç (‡§ú‡•à‡§∏‡•á, *): ');
    const adminID = await getInput('üëë ‡§Ö‡§™‡§®‡§æ ‡§è‡§°‡§Æ‡§ø‡§® ‡§Ü‡§à‡§°‡•Ä ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç: ');

    // Appstate JSON ‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
    let appState;
    try {
        appState = JSON.parse(fs.readFileSync(appstatePath, 'utf8'));
    } catch (err) {
        console.error('‚ùå Appstate JSON ‡§´‡§º‡§æ‡§á‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä ‡§Ø‡§æ ‡§Ø‡§π ‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§π‡•à‡•§');
        process.exit(1);
    }

    // ws3-fca ‡§∏‡•á ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç
    login({ appState }, (err, api) => {
        if (err) return console.error('‚ùå ‡§≤‡•â‡§ó‡§ø‡§® ‡§µ‡§ø‡§´‡§≤:', err);

        console.log('\n‚úÖ ‡§¨‡•â‡§ü ‡§ö‡§≤ ‡§∞‡§π‡§æ ‡§π‡•à ‡§î‡§∞ ‡§ï‡§Æ‡§æ‡§Ç‡§° ‡§∏‡•Å‡§® ‡§∞‡§π‡§æ ‡§π‡•à...');
        api.setOptions({ listenEvents: true });

        const lockedGroups = {}; // ‡§ó‡•Å‡§™ ‡§®‡§æ‡§Æ ‡§ü‡•ç‡§∞‡•à‡§ï ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è
        const lockedNicknames = {}; // ‡§®‡§ø‡§ï‡§®‡•á‡§Æ ‡§ü‡•ç‡§∞‡•à‡§ï ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è

        api.listenMqtt((err, event) => {
            if (err) return console.error('‚ùå ‡§∏‡•Å‡§®‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', err);

            if (event.type === 'message' && event.body.startsWith(prefix)) {
                const senderID = event.senderID;
                const args = event.body.slice(prefix.length).trim().split(' ');
                const command = args[0].toLowerCase();
                const groupName = args.slice(2).join(' ');

                // ‡§ï‡•á‡§µ‡§≤ ‡§è‡§°‡§Æ‡§ø‡§® ‡§π‡•Ä ‡§ï‡§Æ‡§æ‡§Ç‡§° ‡§ö‡§≤‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à
                if (senderID !== adminID) {
                    return api.sendMessage('‚ùå ‡§Ü‡§™‡§ï‡•ã ‡§Ø‡§π ‡§ï‡§Æ‡§æ‡§Ç‡§° ‡§ö‡§≤‡§æ‡§®‡•á ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§', event.threadID);
                }

                // ‡§ó‡•Å‡§™ ‡§®‡§æ‡§Æ ‡§≤‡•â‡§ï ‡§ï‡§∞‡•á‡§Ç
                if (command === 'grouplockname' && args[1] === 'on') {
                    lockedGroups[event.threadID] = groupName;
                    api.setTitle(groupName, event.threadID, (err) => {
                        if (err) return api.sendMessage('‚ùå ‡§ó‡•Å‡§™ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§≤‡•â‡§ï ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§', event.threadID);
                        api.sendMessage(`‚úÖ ‡§ó‡•Å‡§™ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§≤‡•â‡§ï ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ: ${groupName}`, event.threadID);
                    });
                }

                // ‡§®‡§ø‡§ï‡§®‡•á‡§Æ ‡§≤‡•â‡§ï ‡§ï‡§∞‡•á‡§Ç
                else if (command === 'nicknamelock' && args[1] === 'on') {
                    const nickname = groupName;

                    api.getThreadInfo(event.threadID, (err, info) => {
                        if (err) return console.error('‚ùå ‡§ó‡•Å‡§™ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§≤‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', err);

                        const delay = 2000; // ‡§π‡§∞ ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§™‡§∞ 2 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§ï‡§æ ‡§°‡§ø‡§≤‡•á
                        info.participantIDs.forEach((userID, index) => {
                            setTimeout(() => {
                                api.changeNickname(nickname, event.threadID, userID, (err) => {
                                    if (err) console.error(`‚ùå ‡§Ø‡•Ç‡§ú‡§º‡§∞ ${userID} ‡§ï‡•á ‡§≤‡§ø‡§è ‡§®‡§ø‡§ï‡§®‡•á‡§Æ ‡§∏‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤:`, err);
                                });
                            }, index * delay);
                        });

                        // ‡§®‡§ø‡§ï‡§®‡•á‡§Æ ‡§≤‡•â‡§ï ‡§ï‡§∞‡•á‡§Ç
                        lockedNicknames[event.threadID] = nickname;
                        api.sendMessage(`‚úÖ ‡§∏‡§≠‡•Ä ‡§®‡§ø‡§ï‡§®‡•á‡§Æ ‡§≤‡•â‡§ï ‡§ï‡§ø‡§è ‡§ó‡§è: ${nickname}`, event.threadID);
                    });
                }

                // ‡§≤‡•â‡§ï ‡§∏‡•ç‡§ü‡•á‡§ü‡§∏ ‡§¶‡•á‡§ñ‡•á‡§Ç
                else if (command === 'lockstatus') {
                    const lockStatus = `üîí ‡§≤‡•â‡§ï ‡§∏‡•ç‡§ü‡•á‡§ü‡§∏:\n‡§ó‡•Å‡§™ ‡§ï‡§æ ‡§®‡§æ‡§Æ: ${
                        lockedGroups[event.threadID] || '‡§≤‡•â‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à'
                    }\n‡§®‡§ø‡§ï‡§®‡•á‡§Æ: ${lockedNicknames[event.threadID] || '‡§≤‡•â‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à'}`;
                    api.sendMessage(lockStatus, event.threadID);
                }
            }

            // ‡§¨‡§æ‡§π‡§∞‡•Ä ‡§ó‡•Å‡§™ ‡§®‡§æ‡§Æ ‡§¨‡§¶‡§≤‡§®‡•á ‡§∏‡•á ‡§∞‡•ã‡§ï‡•á‡§Ç
            if (event.logMessageType === 'log:thread-name') {
                const lockedName = lockedGroups[event.threadID];
                if (lockedName) {
                    api.setTitle(lockedName, event.threadID, (err) => {
                        if (!err) api.sendMessage('‚ùå ‡§ó‡•Å‡§™ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§¨‡§¶‡§≤‡§®‡§æ ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§', event.threadID);
                    });
                }
            }

            // ‡§¨‡§æ‡§π‡§∞‡•Ä ‡§®‡§ø‡§ï‡§®‡•á‡§Æ ‡§¨‡§¶‡§≤‡§®‡•á ‡§∏‡•á ‡§∞‡•ã‡§ï‡•á‡§Ç
            if (event.logMessageType === 'log:thread-nickname') {
                const lockedNickname = lockedNicknames[event.threadID];
                if (lockedNickname) {
                    const affectedUserID = event.logMessageData.participant_id;
                    api.changeNickname(lockedNickname, event.threadID, affectedUserID, (err) => {
                        if (!err) api.sendMessage('‚ùå ‡§®‡§ø‡§ï‡§®‡•á‡§Æ ‡§¨‡§¶‡§≤‡§®‡§æ ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§', event.threadID);
                    });
                }
            }
        });
    });
})();
